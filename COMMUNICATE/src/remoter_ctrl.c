#include "remoter_ctrl.h"
#include "commander.h"
#include "config_param.h"
#include "flip.h"
#include "ledring12.h"
#include "module_mgt.h"
#include "pm.h"
#include "radiolink.h"
#include "sensfusion6.h"
#include "sensors.h"
#include "stabilizer.h"
#include "string.h"
#include "vl53lxx.h"
#include <math.h>

/*FreeRTOS相关头文件*/
#include "FreeRTOS.h"
#include "task.h"

static ctrlVal_t remoterCtrl; /*发送到commander姿态控制数据*/
static MiniFlyMsg_t msg;
static u8 reSendTimes = 3; /*微调重发次数*/

/*返回四轴信息*/
void sendMsgACK(void)
{
    msg.version = configParam.version;
    msg.mpu_selfTest = getIsMPU9250Present();
    msg.baro_slfTest = getIsBaroPresent();
    msg.isCanFly = getIsCalibrated();
    if (msg.isCanFly == true) /*校准通过之后发送微调值*/
    {
        if (reSendTimes > 0) /*微调重发次数*/
        {
            reSendTimes--;
            msg.trimPitch = configParam.trimP;
            msg.trimRoll = configParam.trimR;
        }
    }
    msg.isLowpower = getIsLowpower();
    msg.moduleID = getModuleID();

    atkp_t p;
    p.msgID = UP_REMOTER;
    p.dataLen = sizeof(msg) + 1;
    p.data[0] = ACK_MSG;
    memcpy(p.data + 1, &msg, sizeof(msg));
    radiolinkSendPacketBlocking(&p);
}

/*遥控数据接收处理*/
void remoterCtrlProcess(atkp_t* pk)
{
    if (pk->data[0] == REMOTER_CMD) {
        switch (pk->data[1]) {
        case CMD_FLIGHT_LAND:
            if (getCommanderKeyFlight() != true) {
                setCommanderKeyFlight(true);
                setCommanderKeyland(false);
            } else {
                setCommanderKeyFlight(false);
                setCommanderKeyland(true);
            }
            break;

        case CMD_EMER_STOP:
            setCommanderKeyFlight(false);
            setCommanderKeyland(false);
            break;

        case CMD_FLIP:
            setFlipDir(pk->data[2]);
            break;

        case CMD_GET_MSG:
            sendMsgACK();
            break;

        case CMD_POWER_MODULE:
            expModulePower(pk->data[2]);
            break;

        case CMD_LEDRING_EFFECT:
            //				expModulePower(true);
            setLedringEffect(pk->data[2]);
            break;

        case CMD_POWER_VL53LXX:
            setVl53lxxState(pk->data[2]);
            break;
        }
    } else if (pk->data[0] == REMOTER_DATA) {
        remoterData_t remoterData = *(remoterData_t*)(pk->data + 1);

        remoterCtrl.roll = remoterData.roll;
        remoterCtrl.pitch = remoterData.pitch;
        #ifdef BI_Fly_2
        remoterCtrl.yaw = -remoterData.yaw;
        #endif
        #ifdef BI_Fly_1
        remoterCtrl.yaw = remoterData.yaw;
        #endif       
        remoterCtrl.thrust = remoterData.thrust * 655.35f;
        remoterCtrl.trimPitch = remoterData.trimPitch;
        remoterCtrl.trimRoll = remoterData.trimRoll;

        setCommanderCtrlMode(remoterData.ctrlMode);
        setCommanderFlightmode(remoterData.flightMode);
        flightCtrldataCache(ATK_REMOTER, remoterCtrl);
    }
}
